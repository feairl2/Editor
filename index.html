<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        html, body { margin: 0; height: 100%; background: #101010; font-family: "Segoe UI", sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Tab 區域 */
        #tabs-container { display: flex; align-items: center; height: 44px; background: #101010; padding: 0 12px; box-sizing: border-box; flex-shrink: 0; border-bottom: 1px solid #1a1a1a; }
        #tabs { display: flex; align-items: center; gap: 6px; }

        .tab { 
            display: flex; align-items: center; height: 32px; padding: 0 12px; 
            color: #777; cursor: pointer; font-size: 13px; border-radius: 6px; 
            transition: all 0.2s; min-width: 110px; border: 1px solid transparent; 
            position: relative; background: #161616;
        }
        .tab.active { background: #2a2a2a; color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.4); }
        .tab:hover:not(.active) { background: #1e1e1e; color: #aaa; }

        /* 分頁叉叉 */
        .close-tab {
            margin-left: 8px; width: 16px; height: 16px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; font-size: 14px; transition: 0.2s;
            color: #555;
        }
        .tab:hover .close-tab { color: #888; }
        .close-tab:hover { background: #ff5f56 !important; color: white !important; }

        #editor { flex: 1; width: 100%; }

        /* Console 區域：預設隱藏 */
        #console-wrapper { 
            height: 180px; background: #101010; 
            padding: 0 15px 15px 15px; box-sizing: border-box; 
            flex-shrink: 0; display: none; 
        }
        #console-panel { 
            background-color: #1a1a1a; height: 100%; width: 100%; 
            border: 1px solid #282828; border-radius: 10px; 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        #console-header { background: #222; padding: 6px 12px; font-size: 11px; color: #555; border-bottom: 1px solid #282828; }
        #log-display { flex: 1; padding: 10px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; color: #ccc; }
        
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-success { color: #ffd700; }
        .log-info { color: #888; }

        .add-btn { 
            width: 28px; height: 28px; margin-left: 10px; border-radius: 6px; 
            background: #1e1e1e; color: #888; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            border: 1px solid #333; font-size: 18px;
        }
    </style>
</head>
<body>

<div id="tabs-container">
    <div id="tabs"></div>
    <div class="add-btn" id="add-tab-btn">+</div>
</div>
<div id="editor"></div>
<div id="console-wrapper">
    <div id="console-panel">
        <div id="console-header">OUTPUT</div>
        <div id="log-display"></div>
    </div>
</div>

<script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], () => {
        monaco.editor.defineTheme('custom-dark', { base: 'vs-dark', inherit: true, colors: { 'editor.background': '#101010' }});
        
        // 資料初始化
        window.tabs = JSON.parse(localStorage.getItem('lua_tabs')) || [{ id: '1', name: 'main.lua', code: '-- Feairl Team\nprint("Hello")' }];
        window.activeTab = localStorage.getItem('lua_active') || '1';

        window.editor = monaco.editor.create(document.getElementById('editor'), {
            value: '', language: 'lua', theme: 'custom-dark', automaticLayout: true, minimap: { enabled: false }
        });

        window.saveData = () => {
            localStorage.setItem('lua_tabs', JSON.stringify(tabs));
            localStorage.setItem('lua_active', activeTab);
        };

        window.renderTabs = () => {
            const container = document.getElementById('tabs');
            container.innerHTML = '';
            tabs.forEach(t => {
                const tabEl = document.createElement('div');
                tabEl.className = `tab ${t.id === activeTab ? 'active' : ''}`;
                tabEl.innerHTML = `<span>${t.name}</span><div class="close-tab">×</div>`;
                
                tabEl.onclick = () => { activeTab = t.id; saveData(); renderTabs(); loadCode(); };
                
                // 叉叉關閉邏輯
                tabEl.querySelector('.close-tab').onclick = (e) => {
                    e.stopPropagation();
                    if (tabs.length <= 1) return;
                    const idx = tabs.findIndex(x => x.id === t.id);
                    tabs.splice(idx, 1);
                    if (activeTab === t.id) activeTab = tabs[Math.max(0, idx - 1)].id;
                    saveData(); renderTabs(); loadCode();
                };
                container.appendChild(tabEl);
            });
        };

        window.loadCode = () => {
            const t = tabs.find(x => x.id === activeTab);
            if (t) editor.setValue(t.code);
        };

        editor.onDidChangeModelContent(() => {
            const t = tabs.find(x => x.id === activeTab);
            if (t) { t.code = editor.getValue(); saveData(); }
        });

        document.getElementById('add-tab-btn').onclick = () => {
            const newId = Date.now().toString();
            tabs.push({ id: newId, name: 'script.lua', code: '' });
            activeTab = newId; saveData(); renderTabs(); loadCode();
        };

        renderTabs(); loadCode();
    });

    // --- 外部呼叫接口 ---
    window.setConsoleVisible = (visible) => {
        const wrapper = document.getElementById('console-wrapper');
        if (wrapper) {
            wrapper.style.display = visible ? 'block' : 'none';
            if (window.editor) window.editor.layout(); // 讓編輯器補滿空間
        }
    };

    window.appendLog = (msg, type = 'info') => {
        const div = document.createElement('div');
        div.className = `log-line log-${type}`;
        div.innerText = `> ${msg}`;
        const display = document.getElementById('log-display');
        display.appendChild(div);
        display.scrollTop = display.scrollHeight;
    };
</script>
</body>
</html>
