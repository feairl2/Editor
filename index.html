<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Editor</title>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
html,body{
    margin:0;
    height:100%;
    background:#080808; /* 稍微加深底色以貼合圖示 */
    font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
    overflow:hidden;
}

/* ===== TAB BAR ===== */
#tabs-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 35px; /* 高度調窄 */
    background: #0d0d0d;
    border-bottom: 1px solid #1a1a1a;
    padding-right: 10px;
}

#tabs {
    display: flex;
    align-items: flex-end; /* 讓分頁靠下對齊 */
    height: 100%;
    gap: 0px;
}

/* ===== TAB ===== */
.tab {
    display: flex;
    align-items: center;
    height: 30px;
    padding: 0 12px;
    background: transparent;
    color: #969696;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
    position: relative;
    border-right: 1px solid #1a1a1a;
    transition: background .1s;
}

.tab:hover {
    background: #161616;
    color: #ccc;
}

.tab.active {
    background: #111111;
    color: #ffffff;
    /* 選中時的頂部高亮條 */
    border-top: 1px solid #3e3e3e; 
    height: 31px; /* 稍微高一點點覆蓋底邊 */
}

/* 分頁圖示 */
.tab-icon {
    width: 14px;
    height: 14px;
    margin-right: 8px;
    opacity: 0.7;
}

.tab-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab input.rename {
    background: transparent;
    border: none;
    outline: none;
    color: #ffffff;
    font-size: 12px;
    width: 60px;
}

/* ===== CLOSE BUTTON (極細) ===== */
.close {
    width: 14px;
    height: 14px;
    margin-left: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 2px;
}

.close:hover {
    background: #333;
}

.close svg {
    width: 8px;
    height: 8px;
    stroke: #8f8f8f;
    stroke-width: 1.2px;
}

.close:hover svg {
    stroke: #ffffff;
}

/* ===== ADD BUTTON (右側極細) ===== */
.add-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    cursor: pointer;
    color: #8f8f8f;
    transition: color .2s;
}

.add-btn:hover {
    color: #ffffff;
}

.add-btn svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    stroke-width: 1px;
}

/* ===== EDITOR ===== */
#editor {
    width: 100%;
    height: calc(100% - 35px);
}
</style>
</head>

<body>
<div id="tabs-container">
    <div id="tabs"></div>
    <div class="add-btn" id="add-tab-btn">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V19M5 12H19" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
</div>
<div id="editor"></div>

<script>
require.config({
    paths:{ vs:'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
});

require(['vs/editor/editor.main'], () => {

/* ===== THEME ===== */
monaco.editor.defineTheme('dark-executor', {
    base:'vs-dark',
    inherit:true,
    rules:[
        {token:'keyword',foreground:'c586c0'},
        {token:'number',foreground:'b5cea8'},
        {token:'string',foreground:'ce9178'},
        {token:'comment',foreground:'6a9955'},
        {token:'identifier',foreground:'9cdcfe'}
    ],
    colors:{
        'editor.background':'#0d0d0d',
        'editor.lineHighlightBackground':'#1a1a1a',
        'editorCursor.foreground':'#ffffff',
        'editor.selectionBackground':'#2a2a2a'
    }
});

/* ===== DATA ===== */
window.tabs = JSON.parse(localStorage.getItem('lua_tabs')) || [{
    id:'script_1',
    name:'New Tab 1',
    code:'-- Welcome\nprint("Hello World")'
}];
window.activeTab = localStorage.getItem('lua_active') || tabs[0].id;

/* ===== EDITOR ===== */
window.editor = monaco.editor.create(
    document.getElementById('editor'),
    {
        value:'',
        language:'lua',
        theme:'dark-executor',
        fontSize:13,
        minimap:{ enabled:false },
        smoothScrolling:true,
        cursorSmoothCaretAnimation:true,
        cursorBlinking:'smooth',
        lineNumbersMinChars: 3
    }
);

const tabsDiv = document.getElementById('tabs');

function save(){
    localStorage.setItem('lua_tabs',JSON.stringify(tabs));
    localStorage.setItem('lua_active',activeTab);
}

function renderTabs(){
    tabsDiv.innerHTML='';

    tabs.forEach(t=>{
        const tab=document.createElement('div');
        tab.className='tab'+(t.id===activeTab?' active':'');

        // 左側文件圖示
        const icon = `<svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;

        tab.innerHTML = `
            ${icon}
            <div class="tab-content">
                <span class="tab-label">${t.name}</span>
            </div>
            <div class="close" data-id="${t.id}">
                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
        `;

        // 雙擊改名
        tab.ondblclick=e=>{
            const label = tab.querySelector('.tab-label');
            const input=document.createElement('input');
            input.className='rename';
            input.value=t.name;
            label.parentNode.replaceChild(input,label);
            input.focus();
            input.select();
            input.onkeydown=ev=>{
                if(ev.key==='Enter'){
                    t.name=input.value.trim()||t.name;
                    save(); renderTabs();
                }
            };
            input.onblur=()=>renderTabs();
        };

        // 點擊切換
        tab.onclick=()=>{
            activeTab=t.id;
            save(); renderTabs(); loadTab();
        };

        // 刪除邏輯
        tab.querySelector('.close').onclick=e=>{
            e.stopPropagation();
            if(tabs.length === 1) return; // 剩一個不刪除
            tabs=tabs.filter(x=>x.id!==t.id);
            if(activeTab === t.id) activeTab=tabs[0].id;
            save(); renderTabs(); loadTab();
        };

        tabsDiv.appendChild(tab);
    });
}

// 右側加號點擊
document.getElementById('add-tab-btn').onclick=()=>{
    const id = 'script_' + Date.now();
    const n = tabs.length + 1;
    tabs.push({ id, name: 'New Tab ' + n, code: '' });
    activeTab = id;
    save(); renderTabs(); loadTab();
};

function loadTab(){
    const t=tabs.find(x=>x.id===activeTab);
    if(t) editor.setValue(t.code);
}

editor.onDidChangeModelContent(()=>{
    const t=tabs.find(x=>x.id===activeTab);
    if(t){ t.code=editor.getValue(); save(); }
});

renderTabs();
loadTab();

// API
window.EditorAPI = {
    getCode: () => window.editor.getValue(),
    setCode: (code) => {
        window.editor.setValue(code || "");
        setTimeout(()=>editor.layout(),0);
    }
};

if(window.chrome && window.chrome.webview){
    window.chrome.webview.postMessage("editor-ready");
}

});
</script>
</body>
</html>
