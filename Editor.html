<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Editor</title>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>

<style>
html,body{
    margin:0;
    height:100%;
    background:#101010;
    font-family:Segoe UI, Roboto, sans-serif;
    overflow:hidden;
}

/* ===== TAB BAR ===== */
#tabs{
    display:flex;
    align-items:center;
    height:41px;
    background:#101010;
    padding:0 8px;
    gap:4px;
}

/* ===== TAB ===== */
.tab{
    display:flex;
    align-items:center;
    height:28px;
    padding:0 10px;
    background:transparent;
    color:#8f8f8f;
    border-radius:4.5px;
    cursor:pointer;
    user-select:none;
    font-size:11.6px;
    transition:background .12s,color .12s;
}
.tab:hover{
    background:#1f1f1f;
    color:#e0e0e0;
}
.tab.active{
    background:#353535;
    color:#ffffff;
}

.tab-content{
    display:flex;
    align-items:center;
    gap:10px;
}

.tab input.rename{
    background:transparent;
    border:none;
    outline:none;
    color:#ffffff;
    font-size:11.6px;
    width:60px;
}

/* ===== CLOSE ===== */
.close{
    width:18px;
    height:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.close svg{
    width:18px;
    height:18px;
    fill:#8f8f8f;
}
.close:hover svg{
    fill:#ffffff;
}
.close.locked{
    opacity:0.4;
    cursor:default;
}
.close.locked:hover svg{
    fill:#8f8f8f;
}

/* ===== + TAB ===== */
.tab.add{
    width:28px;
    padding:0;
    justify-content:center;
}
.tab.add:hover{
    background:#1f1f1f;
}
.plus-icon{
    width:11px;
    height:11px;
    fill:#8f8f8f;
}
.tab.add:hover .plus-icon{
    fill:#ffffff;
}

/* ===== EDITOR ===== */
#editor{
    width:100%;
    height:calc(100% - 41px);
}
</style>
</head>

<body>
<div id="tabs"></div>
<div id="editor"></div>

<script>
require.config({
    paths:{ vs:'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
});

require(['vs/editor/editor.main'], () => {

/* ===== THEME ===== */
monaco.editor.defineTheme('dark-executor', {
    base:'vs-dark',
    inherit:true,
    rules:[
        {token:'keyword',foreground:'c586c0'},
        {token:'number',foreground:'b5cea8'},
        {token:'string',foreground:'ce9178'},
        {token:'comment',foreground:'6a9955'},
        {token:'identifier',foreground:'9cdcfe'}
    ],
    colors:{
        'editor.background':'#101010',
        'editor.lineHighlightBackground':'#1f1f1f',
        'editorCursor.foreground':'#ffffff',
        'editor.selectionBackground':'#2a2a2a'
    }
});

/* ===== DATA ===== */
window.tabs = JSON.parse(localStorage.getItem('lua_tabs')) || [{
    id:'script_1',
    name:'Script 1',
    code:'-- hello\nprint("Hello World")'
}];
window.activeTab = localStorage.getItem('lua_active') || tabs[0].id;

/* ===== EDITOR ===== */
window.editor = monaco.editor.create(
    document.getElementById('editor'),
    {
        value:'',
        language:'lua',
        theme:'dark-executor',
        fontSize:14.5,
        minimap:{ enabled:false },
        smoothScrolling:true,
        cursorSmoothCaretAnimation:true,
        cursorBlinking:'smooth'
    }
);

const tabsDiv = document.getElementById('tabs');

function save(){
    localStorage.setItem('lua_tabs',JSON.stringify(tabs));
    localStorage.setItem('lua_active',activeTab);
}

function renderTabs(){
    tabsDiv.innerHTML='';

    tabs.forEach(t=>{
        const tab=document.createElement('div');
        tab.className='tab'+(t.id===activeTab?' active':'');

        const content=document.createElement('div');
        content.className='tab-content';

        let label=document.createElement('span');
        label.textContent=t.name;

        tab.ondblclick=e=>{
            e.stopPropagation();
            const input=document.createElement('input');
            input.className='rename';
            input.value=t.name;
            content.replaceChild(input,label);
            input.focus();
            input.select();

            input.onkeydown=ev=>{
                if(ev.key==='Enter'){
                    t.name=input.value.trim()||t.name;
                    save(); renderTabs();
                }
                if(ev.key==='Escape'){
                    renderTabs();
                }
            };
            input.onblur=()=>renderTabs();
        };

        const close=document.createElement('div');
        close.className='close';
        if(t.id==='script_1') close.classList.add('locked');

        close.innerHTML=`
            <svg viewBox="0 0 16 16">
                <rect x="2" y="7" width="12" height="2" transform="rotate(45 8 8)"/>
                <rect x="2" y="7" width="12" height="2" transform="rotate(-45 8 8)"/>
            </svg>
        `;

        close.onclick=e=>{
            e.stopPropagation();
            if(t.id==='script_1') return;
            tabs=tabs.filter(x=>x.id!==t.id);
            activeTab=tabs[0]?.id;
            save(); renderTabs(); loadTab();
        };

        content.appendChild(label);
        content.appendChild(close);
        tab.appendChild(content);

        tab.onclick=()=>{
            activeTab=t.id;
            save(); renderTabs(); loadTab();
        };

        tabsDiv.appendChild(tab);
    });

    const add=document.createElement('div');
    add.className='tab add';
    add.innerHTML=`
        <svg class="plus-icon" viewBox="0 0 12 12">
            <rect x="5" y="0" width="2" height="12"/>
            <rect x="0" y="5" width="12" height="2"/>
        </svg>
    `;
    add.onclick=()=>{
        const id = 'script_' + Date.now();
    const n = tabs.length + 1;

    tabs.push({
        id,
        name: 'Script ' + n,
        code: ''
    });

    activeTab = id;
    save();
    renderTabs();
    loadTab();
    };
    tabsDiv.appendChild(add);
}

function loadTab(){
    const t=tabs.find(x=>x.id===activeTab);
    if(t) editor.setValue(t.code);
}

editor.onDidChangeModelContent(()=>{
    const t=tabs.find(x=>x.id===activeTab);
    if(t){ t.code=editor.getValue(); save(); }
});

renderTabs();
loadTab();

/* ===== API FOR WINFORMS ===== */
window.EditorAPI = {
    getCode(){
        if (!window.editor) return "";
        return window.editor.getValue();
    },
    setCode(code){
        if (!window.editor) return;
        window.editor.setValue(code || "");
        setTimeout(()=>editor.layout(),0);
    }
};

/* ===== notify WinForms ===== */
if(window.chrome && window.chrome.webview){
    window.chrome.webview.postMessage("editor-ready");
}

});
</script>
</body>
</html>
